<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cryptocurrency Volatility Index (CVI)</title>

  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- silence favicon 404s on GitHub Pages -->
  <link rel="icon" href="data:,">

  <style>
    :root { --fg:#111; --muted:#666; --pill:#eef3ff; --pill-active:#d8e4ff; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: var(--fg); }
    h1 { margin: 0 0 8px 0; }
    .muted { color: var(--muted); font-size: 12px; margin: 6px 0 14px; }
    .tabs { display:flex; gap:8px; overflow-x:auto; padding:6px 0 10px; }
    .tab { white-space:nowrap; padding:6px 12px; border-radius:999px; background:var(--pill); cursor:pointer; font-weight:600; border:0; }
    .tab.active { background:var(--pill-active); }
    .layout { max-width: 1200px; display: grid; gap: 18px; }
    .row { display:grid; grid-template-columns: 2fr 1fr; gap:16px; align-items:start; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; position:relative; min-height:120px; }
    .loading { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; color:#888; pointer-events:none; }
    .hidden { display:none; }
    .signal-title { font-weight:700; }
    .signal-meta { font-size:12px; color:#555; margin-top:4px; }
    canvas { background:#fff; border-radius:8px; }
    hr { border:0; border-top:1px solid #eee; margin:10px 0; }
  </style>
</head>
<body>
  <h1>Cryptocurrency Volatility Index (CVI)</h1>
  <div class="muted" id="runInfo">Loading…</div>

  <div class="tabs" id="assetTabs"></div>

  <div class="layout">
    <div class="row">
      <div class="card">
        <div id="seriesLoading" class="loading">Loading series…</div>
        <canvas id="cviSeries" height="190"></canvas>
      </div>
      <div class="card" id="signalCard">
        <div class="signal-title">Signal</div>
        <div id="signalBody" class="signal-meta">Waiting…</div>
        <hr/>
        <div class="signal-title" style="margin-top:8px;">Recent signals</div>
        <div id="signalTable" class="signal-meta"></div>
      </div>
    </div>

    <h3 style="margin-top:4px">Volatility smile — ~30-day expiry</h3>
    <div class="card">
      <div id="smileLoading" class="loading">Loading smile…</div>
      <canvas id="cviSmile" height="300"></canvas>
    </div>
  </div>

  <script>
    /* ------------ config/caching ------------ */
    const CACHE_TTL_MS = 2 * 60 * 1000; // 2 minutes
    const cache = {}; // { BTC: {series, smile, sigs, ts} }
    let loadSeq = 0;  // protects against rapid tab clicks

    /* ------------ safe fetch helpers ------------ */
    async function jsonSafe(url, fallback) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) return fallback;
        return await r.json();
      } catch {
        return fallback;
      }
    }

    function setActiveTab(sym){
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.sym === sym));
    }

    function show(el, on) {
      el.classList.toggle('hidden', !on);
    }

    /* ------------ chart helpers (destroy-safe) ------------ */
    function ctxFor(canvasId){
      const el = document.getElementById(canvasId);
      const existing = Chart.getChart(el);
      if (existing) existing.destroy();
      return el.getContext('2d');
    }

    function drawSeries(series){
      const ctx = ctxFor('cviSeries');
      const labels = series.map(p => new Date(p.t));
      const atm    = series.map(p => (p.atm_iv ?? null));
      const vega   = series.map(p => (p.vega_weighted_iv ?? null));
      const showPoints = labels.length < 3 ? 3 : 0;

      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label:'CVI (ATM 30-day IV)',    data: atm,  borderWidth:2, tension:0.2, pointRadius: showPoints },
            { label:'CVI (Vega-weighted IV)', data: vega, borderWidth:2, tension:0.2, pointRadius: showPoints }
          ]
        },
        options: {
          maintainAspectRatio: false,
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'minute' }, ticks: { maxTicksLimit: 8 } },
            y: { title: { display:true, text:'IV' } }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              mode: 'index', intersect: false,
              callbacks: { title: (items) => items?.length ? new Date(items[0].parsed.x).toLocaleString() : '' }
            }
          }
        }
      });
    }

    function drawSmile(smile){
      const ctx = ctxFor('cviSmile');

      if (!Array.isArray(smile) || !smile.length){
        // empty placeholder chart (no legend)
        new Chart(ctx, {
          type:'line',
          data:{ labels:[], datasets:[] },
          options:{ maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
        });
        return;
      }

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: smile.map(p => p.strike),
          datasets: [
            { label: 'Implied Volatility', data: smile.map(p => p.iv), borderWidth: 2, tension: 0.2, pointRadius: 0 }
          ]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Strike' } },
            y: { title: { display: true, text: 'IV' } }
          },
          plugins: { legend: { position: 'top' } }
        }
      });
    }

    function renderSignals(sigs){
      const body = document.getElementById('signalBody');
      const tbl  = document.getElementById('signalTable');
      if (!sigs || !sigs.length){
        body.textContent = 'No signals yet (need more history).';
        tbl.textContent = '';
        return;
      }
      const last = sigs[sigs.length - 1];
      body.innerHTML = `
        <div><b>${last.recommendation}</b> — strength ${Math.round((last.strength||0)*100)}% (size hint ${last.size_hint ?? '—'}x)</div>
        <div>${last.reason || ''}</div>
        <div>IV: ${Number(last.last_iv ?? NaN).toFixed?.(4) || 'n/a'}
            | EMA20: ${Number(last.ema20 ?? NaN).toFixed?.(4) || 'n/a'}
            | EMA100: ${Number(last.ema100 ?? NaN).toFixed?.(4) || 'n/a'}</div>
        <div>${new Date(last.ts).toLocaleString()}</div>
      `;
      const recent = sigs.slice(-10).reverse().map(s =>
        `<div>• ${new Date(s.ts).toLocaleString()}: <b>${s.recommendation}</b> (${Math.round((s.strength||0)*100)}%)</div>`
      ).join('');
      tbl.innerHTML = recent;
    }

    /* ------------ data orchestration with cache ------------ */
    async function getAssetData(sym) {
      const now = Date.now();
      const entry = cache[sym];
      if (entry && (now - entry.ts) < CACHE_TTL_MS) return entry;

      // fetch once per asset (timeseries is required; others fall back empty)
      const [series, smile, sigs] = await Promise.all([
        jsonSafe(`${sym}/cvi_timeseries.json`, []),
        jsonSafe(`${sym}/cvi.json`, []),
        jsonSafe(`${sym}/signals.json`, [])
      ]);
      const fresh = { series, smile, sigs, ts: now };
      cache[sym] = fresh;
      return fresh;
    }

    async function loadAsset(sym){
      const seq = ++loadSeq;
      setActiveTab(sym);

      // show loaders
      show(document.getElementById('seriesLoading'), true);
      show(document.getElementById('smileLoading'),  true);

      const data = await getAssetData(sym);
      // if another tab was clicked in the meantime, abort render
      if (seq !== loadSeq) return;

      const { series, smile, sigs } = data;

      if (series?.length){
        const last = series[series.length - 1];
        const dte  = (last.days_to_expiry != null && last.days_to_expiry !== 'null') ? `${last.days_to_expiry}d` : 'n/a';
        document.getElementById('runInfo').textContent =
          `Asset: ${sym} — Last: ${new Date(last.t).toLocaleString()} — Spot: $${(last.spot||0).toLocaleString()} — DTE: ${dte}`;
        drawSeries(series);
      } else {
        document.getElementById('runInfo').textContent = `Asset: ${sym} — No history yet.`;
        drawSeries([]); // clear any previous lines
      }
      drawSmile(smile);
      renderSignals(sigs);

      // hide loaders
      show(document.getElementById('seriesLoading'), false);
      show(document.getElementById('smileLoading'),  false);
    }

    /* ------------ init ------------ */
    (async function init(){
      const manifest = await jsonSafe('cvi_manifest.json', null);
      const tabs = document.getElementById('assetTabs');
      tabs.innerHTML = '';
      if (!manifest?.assets?.length){
        document.getElementById('runInfo').textContent = 'No assets available yet.';
        return;
      }
      manifest.assets.forEach(a => {
        const el = document.createElement('button');
        el.className = 'tab';
        el.dataset.sym = a.symbol;
        el.textContent = a.symbol;
        el.onclick = () => loadAsset(a.symbol);
        tabs.appendChild(el);
      });
      loadAsset(manifest.assets[0].symbol);
    })();
  </script>
</body>
</html>
