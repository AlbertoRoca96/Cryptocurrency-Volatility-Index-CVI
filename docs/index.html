<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cryptocurrency Volatility Index (CVI)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .chart-wrap { max-width: 1200px; }
    .muted { color:#666; font-size: 12px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <h1>Cryptocurrency Volatility Index (CVI)</h1>
  <div class="muted" id="runInfo"></div>

  <div class="chart-wrap">
    <canvas id="cviSeries" height="160"></canvas>
  </div>

  <h3 style="margin-top:28px">Volatility smile — ~30-day expiry</h3>
  <div class="chart-wrap">
    <canvas id="cviSmile" height="260"></canvas>
  </div>

  <script>
    async function safeJSON(url) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      } catch (e) { return null; }
    }

    (async function init() {
      // time series
      const series = await safeJSON('cvi_timeseries.json');
      const seriesEl = document.getElementById('cviSeries').getContext('2d');

      if (series && series.length) {
        const labels = series.map(p => new Date(p.t).toLocaleString());
        const atm = series.map(p => p.atm_iv ?? null);
        const vegaW = series.map(p => p.vega_weighted_iv ?? null);
        const last = series[series.length - 1];
        document.getElementById('runInfo').textContent =
          `Last update: ${new Date(last.t).toLocaleString()} — Spot: $${(last.spot||0).toLocaleString()} — DTE: ${last.days_to_expiry}d`;

        new Chart(seriesEl, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'CVI (ATM 30-day IV)', data: atm, borderWidth: 2, tension: 0.2, pointRadius: 0 },
              { label: 'CVI (Vega-weighted IV)', data: vegaW, borderWidth: 2, tension: 0.2, pointRadius: 0 }
            ]
          },
          options: {
            maintainAspectRatio: false,
            scales: { y: { title: { text: 'IV', display: true } }, x: { ticks: { autoSkip: true, maxTicksLimit: 12 } } },
            plugins: { legend: { position: 'top' } }
          }
        });
      } else {
        document.getElementById('runInfo').textContent = 'No CVI history yet – will populate on the next workflow run.';
      }

      // smile
      const smile = await safeJSON('cvi.json');
      const smileEl = document.getElementById('cviSmile').getContext('2d');

      if (smile && smile.length) {
        new Chart(smileEl, {
          type: 'line',
          data: {
            labels: smile.map(p => p.strike),
            datasets: [
              { label: 'Implied Volatility', data: smile.map(p => p.iv), borderWidth: 2, tension: 0.2, pointRadius: 0 }
            ]
          },
          options: {
            maintainAspectRatio: false,
            scales: { y: { title: { text: 'IV', display: true } }, x: { title: { text: 'Strike', display: true } } },
            plugins: { legend: { position: 'top' } }
          }
        });
      }
    })();
  </script>
</body>
</html>
