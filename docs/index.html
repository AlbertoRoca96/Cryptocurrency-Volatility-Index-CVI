<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cryptocurrency Volatility Index</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    h1 { margin-bottom: 8px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 28px; }
    @media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
    canvas { width: 100%; height: 360px; }
    .meta { color:#666; font-size: 0.9rem; margin: 4px 0 16px; }
  </style>
</head>
<body>
  <h1>Cryptocurrency Volatility Index (CVI)</h1>
  <div class="meta" id="meta"></div>

  <div class="grid">
    <div>
      <h3>30-Day Expiry Smile</h3>
      <canvas id="cviChart"></canvas>
    </div>
    <div>
      <h3>CVI Time Series (every ~30 min)</h3>
      <canvas id="cviTSChart"></canvas>
    </div>
  </div>

  <script>
    Promise.all([
      fetch('cvi.json').then(r => r.ok ? r.json() : []).catch(() => []),
      fetch('cvi_timeseries.json').then(r => r.ok ? r.json() : []).catch(() => [])
    ]).then(([smile, ts]) => {
      // Meta (latest point)
      if (Array.isArray(ts) && ts.length) {
        const last = ts[ts.length - 1];
        document.getElementById('meta').textContent =
          `Spot: ${last.spot?.toLocaleString?.() ?? last.spot} | ` +
          `Expiry: ${new Date(last.expiry_iso).toLocaleString()} | ` +
          `ATM IV: ${last.atm_iv ?? '—'} | Vega-weighted IV: ${last.vega_weighted_iv ?? '—'}`;
      }

      // Smile chart
      const smileLabels = (smile || []).map(r => r.strike);
      const smileIVs = (smile || []).map(r => r.implied_volatility);
      const cviCtx = document.getElementById('cviChart').getContext('2d');
      new Chart(cviCtx, {
        type: 'line',
        data: {
          labels: smileLabels,
          datasets: [{ label: 'Implied Volatility', data: smileIVs, borderWidth: 2, fill: false, tension: 0.2 }]
        },
        options: { scales: { x: { ticks: { maxRotation: 60, minRotation: 60 }}, y: { beginAtZero: true } } }
      });

      // Time series chart
      const tsLabels = (ts || []).map(p => new Date(p.timestamp));
      const atm = (ts || []).map(p => p.atm_iv);
      const vegaW = (ts || []).map(p => p.vega_weighted_iv);
      const tsCtx = document.getElementById('cviTSChart').getContext('2d');
      new Chart(tsCtx, {
        type: 'line',
        data: {
          labels: tsLabels,
          datasets: [
            { label: 'ATM 30d IV', data: atm, borderWidth: 2, fill: false, tension: 0.2 },
            { label: 'Vega-weighted 30d IV', data: vegaW, borderWidth: 2, fill: false, tension: 0.2 }
          ]
        },
        options: {
          parsing: false,
          scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { beginAtZero: true } }
        }
      });
    });
  </script>
</body>
</html>
